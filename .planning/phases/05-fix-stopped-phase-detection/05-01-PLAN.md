---
phase: 05-fix-stopped-phase-detection
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - get-shit-done/workflows/yolo.md
  - /home/junbeom/.claude/get-shit-done/workflows/yolo.md
  - /home/junbeom/.claude/commands/gsd/yolo.md
  - .planning/REQUIREMENTS.md
autonomous: true
requirements: [FAIL-01, FAIL-02, STATE-04]

must_haves:
  truths:
    - "When verification finds gaps_found on Phase N, C2 identifies Phase N (not N+1) as STOPPED_PHASE"
    - "Case B1 fires showing session summary (phases completed + elapsed time) plus specific verification gaps and investigation hint"
    - "yolo-state fail records the correct failed phase number in the stanza"
    - "Re-invoking /gsd:yolo after gaps_found failure auto-detects the situation and enters gap closure mode without user prompting"
    - "After gap closure succeeds, YOLO continues chaining to subsequent phases"
    - "After gap closure fails, YOLO stops permanently (one-attempt limit enforced)"
    - "/gsd:yolo command is installed and invocable from ~/.claude/commands/gsd/yolo.md"
    - "REQUIREMENTS.md checkboxes for FAIL-01, FAIL-02, STATE-04 are checked"
  artifacts:
    - path: "get-shit-done/workflows/yolo.md"
      provides: "Fixed STOPPED_PHASE derivation, enriched B1 banner, auto gap-closure A3 Branch 3"
    - path: "/home/junbeom/.claude/get-shit-done/workflows/yolo.md"
      provides: "Installed copy of fixed workflow (absolute paths)"
    - path: "/home/junbeom/.claude/commands/gsd/yolo.md"
      provides: "Installed slash command entry point"
    - path: ".planning/REQUIREMENTS.md"
      provides: "Updated checkboxes for FAIL-01, FAIL-02, STATE-04"
  key_links:
    - from: "yolo.md C2"
      to: "roadmap analyze phases array"
      via: "jq filter for disk_status=complete AND roadmap_complete=false"
      pattern: "select\\(.disk_status == .complete. and .roadmap_complete == false\\)"
    - from: "yolo.md A3 Branch 3"
      to: "yolo-state stanza failure_reason"
      via: "grep for gaps keyword to detect gap-closure scenario"
      pattern: "grep.*gaps"
    - from: "yolo.md A3 gap closure"
      to: "plan-phase --gaps + execute-phase"
      via: "Task() spawn for gap closure then continuation"
      pattern: "plan-phase.*--gaps"
---

<objective>
Fix the STOPPED_PHASE derivation bug in yolo.md C2 so YOLO correctly identifies the failed phase after `gaps_found` verification failure, add session summary to the B1 stop banner, upgrade A3 Branch 3 to auto-detect gap closure scenarios and run targeted fixes automatically, install the `/gsd:yolo` command, and update REQUIREMENTS.md checkboxes.

Purpose: Close all gaps from the v1.0 milestone audit — YOLO's failure detection, display, and resume all work correctly.
Output: Fixed yolo.md (source + installed), installed command file, updated requirements.
</objective>

<execution_context>
@/home/junbeom/.claude/get-shit-done/workflows/execute-plan.md
@/home/junbeom/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-fix-stopped-phase-detection/05-RESEARCH.md
@.planning/phases/05-fix-stopped-phase-detection/05-CONTEXT.md
@.planning/phases/03-integration-and-failure-hardening/03-02-SUMMARY.md
@.planning/phases/04-resume-and-visibility/04-01-SUMMARY.md
@get-shit-done/workflows/yolo.md
@/home/junbeom/.claude/get-shit-done/workflows/yolo.md
@.planning/REQUIREMENTS.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix C2 STOPPED_PHASE derivation and enrich B1 banner with session summary</name>
  <files>get-shit-done/workflows/yolo.md, /home/junbeom/.claude/get-shit-done/workflows/yolo.md</files>
  <action>
In yolo.md C2, replace the broken STOPPED_PHASE derivation (line ~238: `STOPPED_PHASE = the value of next_phase from roadmap analyze`) with the correct logic that scans the phases array for `disk_status == "complete" AND roadmap_complete == false`. This uniquely identifies the phase where verification ran but found gaps (all SUMMARYs written but `phase complete` never called).

**C2 STOPPED_PHASE fix — replace the "Determine the stopped phase" paragraph and surrounding code:**

Replace the current line:
```
Determine the stopped phase: `STOPPED_PHASE` = the value of `next_phase` from roadmap analyze. This is the phase that did NOT complete.
```

With:
```
Determine the stopped phase by scanning the phases array for the first phase with `disk_status == "complete"` AND `roadmap_complete == false`. This uniquely identifies a phase where all plans executed (SUMMARYs written) but verification failed (phase complete never called).

```bash
STOPPED_PHASE=$(echo "$ANALYZE" | jq -r '
  .phases[]
  | select(.disk_status == "complete" and .roadmap_complete == false)
  | .number
' | head -1)
```

Fallback: if no phase matches (unexpected stop before summaries were written), use `next_phase`:

```bash
if [ -z "$STOPPED_PHASE" ]; then
  STOPPED_PHASE=$(echo "$ANALYZE" | jq -r '.next_phase // empty')
fi
```
```

**B1 banner enrichment — add session summary before the existing failure details:**

After computing STOPPED_PHASE and before the VERIFY_FILE check, add session summary data assembly:

```bash
COMPLETED=$(echo "$ANALYZE" | jq -r '.completed_phases')
TOTAL=$(echo "$ANALYZE" | jq -r '.phase_count')

# Elapsed time from YOLO stanza timestamp (read in C1 as YOLO_STATE)
YOLO_TS=$(echo "$YOLO_STATE" | jq -r '.timestamp // ""')
START_EPOCH=$(date -d "$YOLO_TS" +%s 2>/dev/null)
if [ -n "$START_EPOCH" ]; then
  NOW_EPOCH=$(date +%s)
  ELAPSED_SECS=$((NOW_EPOCH - START_EPOCH))
  ELAPSED_MINS=$((ELAPSED_SECS / 60))
  ELAPSED_SECS_REM=$((ELAPSED_SECS % 60))
  ELAPSED="${ELAPSED_MINS}m ${ELAPSED_SECS_REM}s"
else
  ELAPSED="unknown"
fi
```

Update the B1 STOPPED banner to include the session summary line after the header:

```
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
 GSD ► YOLO STOPPED — Phase {STOPPED_PHASE}
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

Session: {COMPLETED} of {TOTAL} phases completed — {ELAPSED} elapsed

Verification failed: Phase {STOPPED_PHASE} has unmet requirements.

**What was missing:**
{gaps section from VERIFICATION.md}

YOLO state preserved. See {VERIFY_FILE} for full report.
To investigate: `/gsd:plan-phase {STOPPED_PHASE} --gaps`
```

Also update the B1 `yolo-state fail` reason to include more detail:

```bash
node ~/.claude/get-shit-done/bin/gsd-tools.cjs yolo-state fail --phase "${STOPPED_PHASE}" --reason "verification gaps found on phase ${STOPPED_PHASE}"
```

**Important path differences between the two copies:**
- Source (`get-shit-done/workflows/yolo.md`): Uses `~/.claude/` paths
- Installed (`/home/junbeom/.claude/get-shit-done/workflows/yolo.md`): Uses `/home/junbeom/.claude/` paths

Both files must receive identical logic changes with the appropriate path prefix.
  </action>
  <verify>
1. Read both yolo.md copies and confirm the STOPPED_PHASE derivation uses `jq` filter on phases array for `disk_status == "complete" and .roadmap_complete == false`, NOT `next_phase`
2. Confirm B1 banner includes the "Session: X of Y phases completed — Zm Ws elapsed" line between the header and the "Verification failed" line
3. Confirm the fallback to `next_phase` exists for the case where no phase matches the filter
4. Confirm the `yolo-state fail` reason string includes the phase number
  </verify>
  <done>C2 correctly identifies the failed phase after gaps_found (not N+1), B1 banner shows session summary with phases completed count and elapsed time before the failure details, and both source and installed copies are in sync</done>
</task>

<task type="auto">
  <name>Task 2: Upgrade A3 Branch 3 to auto gap-closure mode and install command</name>
  <files>get-shit-done/workflows/yolo.md, /home/junbeom/.claude/get-shit-done/workflows/yolo.md, /home/junbeom/.claude/commands/gsd/yolo.md, .planning/REQUIREMENTS.md</files>
  <action>
**A3 Branch 3 rewrite — replace the current user-prompt flow with auto gap-closure detection:**

The current Branch 3 shows a YOLO RESUME banner and asks the user to choose Resume/Start fresh/Abort via AskUserQuestion. Replace this entire Branch 3 with the following logic:

1. **Detect scenario type from stanza `failure_reason`:**

```bash
YOLO_REASON=$(echo "$YOLO_JSON" | jq -r '.failure_reason // "unknown"')
```

Three sub-branches within Branch 3:

**Branch 3a: Prior gap closure already failed** — `YOLO_REASON` contains "gap closure failed".

Display permanent stop banner:
```
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
 GSD ► YOLO STOPPED — Manual Intervention Required
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

Gap closure was attempted on Phase ${YOLO_FAILED} and failed.
Automatic recovery has been exhausted (one attempt limit).

To resolve manually:
1. Review: .planning/phases/${PADDED}-*/VERIFICATION.md
2. Fix the gaps manually
3. Clear state: run `yolo-state clear`
4. Re-run: `/gsd:yolo`
```
Stop. Do not proceed.

**Branch 3b: Gaps found — enter auto gap-closure mode** — `YOLO_REASON` contains "gaps" (but NOT "gap closure failed").

Display YOLO GAP CLOSURE banner:
```
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
 GSD ► YOLO GAP CLOSURE — Phase {YOLO_FAILED}
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

Auto-detected verification gaps on Phase ${YOLO_FAILED}.
Creating targeted fix plans and executing...
```

Then run gap closure:
- Clear the stale stanza: `yolo-state clear`
- Run `Task(prompt="Run /gsd:plan-phase ${YOLO_FAILED} --gaps --auto")` to create and execute gap-closure plans
- After Task() returns, re-read `roadmap analyze`:
  - Check if Phase YOLO_FAILED now has `roadmap_complete == true`
  - If YES: gap closure succeeded. Set `NEXT_PHASE` from `roadmap analyze .next_phase`. If `NEXT_PHASE` is empty, all phases done — display completion and stop. Otherwise, set `PHASES_REMAINING` and proceed to Phase B (continue chain with remaining phases).
  - If NO: gap closure failed. Write failure state: `yolo-state fail --phase "${YOLO_FAILED}" --reason "gap closure failed — manual intervention required"`, set `auto_advance false`, display "YOLO GAP CLOSURE FAILED" banner, stop permanently.

**Branch 3c: Other failure reason (not gaps-related)** — `YOLO_REASON` does NOT contain "gaps".

Keep the existing YOLO RESUME banner + AskUserQuestion flow (Resume/Start fresh/Abort) for non-gaps failures. This is the original Phase 4 behavior for unexpected errors.

**Command installation:**

Copy the command source file to the install location:
```bash
cp /home/junbeom/Projects/get-shit-done/commands/gsd/yolo.md /home/junbeom/.claude/commands/gsd/yolo.md
```

Verify the file exists after copy.

**REQUIREMENTS.md checkbox updates:**

In `.planning/REQUIREMENTS.md`, change:
- `- [ ] **FAIL-01**` to `- [x] **FAIL-01**`
- `- [ ] **FAIL-02**` to `- [x] **FAIL-02**`
- `- [ ] **STATE-04**` to `- [x] **STATE-04**`

Also update the Traceability table:
- FAIL-01 Status: `Pending` to `Satisfied`
- FAIL-02 Status: `Pending` to `Satisfied`
- STATE-04 Status: `Pending` to `Satisfied`

Update the Coverage section:
- Satisfied: 7 to 10
- Pending line: remove or change to 0

**Important path differences for yolo.md copies:**
- Source: `~/.claude/get-shit-done/bin/gsd-tools.cjs` and `~/.claude/` prefix
- Installed: `/home/junbeom/.claude/get-shit-done/bin/gsd-tools.cjs` and `/home/junbeom/.claude/` prefix
  </action>
  <verify>
1. Read both yolo.md copies and confirm A3 Branch 3 has three sub-branches: 3a (gap closure failed — permanent stop), 3b (gaps found — auto gap closure), 3c (other — YOLO RESUME prompt)
2. Confirm Branch 3b runs `plan-phase --gaps --auto` via Task(), checks `roadmap_complete` for the failed phase after Task() returns, and either continues the chain or stops permanently
3. Confirm Branch 3a checks for "gap closure failed" in the reason BEFORE checking for "gaps" to prevent infinite loops
4. Verify `/home/junbeom/.claude/commands/gsd/yolo.md` exists and has correct frontmatter
5. Read `.planning/REQUIREMENTS.md` and confirm FAIL-01, FAIL-02, STATE-04 checkboxes are `[x]`
6. Confirm Traceability table shows all three as `Satisfied` and Coverage shows 10/10
  </verify>
  <done>A3 Branch 3 auto-detects gaps_found from stanza, enters gap closure mode automatically, continues chain on success, stops permanently on failure (one-attempt limit enforced by failure_reason marker); /gsd:yolo command is installed; REQUIREMENTS.md reflects all requirements satisfied</done>
</task>

</tasks>

<verification>
1. **SC-1 (STOPPED_PHASE accuracy):** In C2, STOPPED_PHASE is derived from phases array scan (`disk_status=complete AND roadmap_complete=false`), not from `next_phase`. This returns Phase N (the failed phase), not Phase N+1.
2. **SC-2 (B1 fires correctly):** B1 condition still checks VERIFY_FILE existence + `gaps_found` status. With the correct STOPPED_PHASE, VERIFY_FILE now points to the right directory, so B1 fires (not B2).
3. **SC-3 (yolo-state fail correct phase):** The `yolo-state fail --phase "${STOPPED_PHASE}"` call uses the corrected STOPPED_PHASE value, recording Phase N.
4. **SC-4 (Resume gap closure):** A3 Branch 3b detects `gaps` in `failure_reason`, auto-enters gap closure mode, creates targeted fix plans via `plan-phase --gaps`, continues chain on success.
5. **SC-5 (Command installed):** `/gsd:yolo` command file exists at `~/.claude/commands/gsd/yolo.md`.
</verification>

<success_criteria>
- C2 STOPPED_PHASE derivation uses phases array jq filter, not next_phase
- B1 banner includes session summary (phases completed + elapsed time) before failure details
- A3 Branch 3 has auto gap-closure mode for gaps_found scenarios
- One-attempt limit prevents infinite gap closure loops
- /gsd:yolo command is installed and invocable
- REQUIREMENTS.md shows FAIL-01, FAIL-02, STATE-04 as satisfied
- Both source and installed yolo.md copies are in sync (logic identical, paths differ)
</success_criteria>

<output>
After completion, create `.planning/phases/05-fix-stopped-phase-detection/05-01-SUMMARY.md`
</output>

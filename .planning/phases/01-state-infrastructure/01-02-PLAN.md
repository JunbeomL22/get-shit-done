---
phase: 01-state-infrastructure
plan: 02
type: execute
wave: 2
depends_on:
  - 01-01
files_modified:
  - /home/junbeom/.claude/get-shit-done/bin/gsd-tools.test.cjs
autonomous: true
requirements:
  - STATE-01
  - STATE-02
  - STATE-03

must_haves:
  truths:
    - "Tests prove config-delete removes a key and handles missing keys idempotently"
    - "Tests prove yolo-state write creates a complete stanza and catches verification failures"
    - "Tests prove yolo-state read returns the stanza or empty object when absent"
    - "Tests prove yolo-state clear removes the stanza idempotently"
    - "Tests prove yolo-state fail preserves existing fields while recording failure info"
    - "Tests prove the full write -> read -> fail -> clear lifecycle works end-to-end"
    - "All tests pass with `node --test`"
  artifacts:
    - path: "/home/junbeom/.claude/get-shit-done/bin/gsd-tools.test.cjs"
      provides: "Test coverage for config-delete and yolo-state commands"
      contains: "describe.*config-delete|describe.*yolo-state"
  key_links:
    - from: "gsd-tools.test.cjs"
      to: "gsd-tools.cjs config-delete command"
      via: "runGsdTools('config-delete ...')"
      pattern: "config-delete"
    - from: "gsd-tools.test.cjs"
      to: "gsd-tools.cjs yolo-state command"
      via: "runGsdTools('yolo-state ...')"
      pattern: "yolo-state"
---

<objective>
Add comprehensive tests for the `config-delete` and `yolo-state` commands added in Plan 01. Tests cover individual command behavior, edge cases (missing keys, missing config.json, idempotent operations), and a full lifecycle integration test that proves write -> read -> survive reset -> fail -> clear works end-to-end.

Purpose: These tests validate that the state infrastructure meets all three STATE requirements (STATE-01, STATE-02, STATE-03) and catches regressions if gsd-tools.cjs is modified in future phases. The lifecycle test specifically maps to the ROADMAP success criteria for Phase 1.

Output: Modified gsd-tools.test.cjs with two new `describe` blocks appended at the end of the file.
</objective>

<execution_context>
@/home/junbeom/.claude/get-shit-done/workflows/execute-plan.md
@/home/junbeom/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-state-infrastructure/01-RESEARCH.md
@/home/junbeom/.claude/get-shit-done/bin/gsd-tools.cjs
@/home/junbeom/.claude/get-shit-done/bin/gsd-tools.test.cjs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add config-delete and yolo-state unit tests</name>
  <files>/home/junbeom/.claude/get-shit-done/bin/gsd-tools.test.cjs</files>
  <action>
Append two new `describe` blocks to the end of gsd-tools.test.cjs (before the file's final closing, after the existing `describe('scaffold command', ...)` block).

**Follow the exact test patterns used in the existing file:**
- Use `createTempProject()` in `beforeEach` and `cleanup(tmpDir)` in `afterEach`
- Use `runGsdTools(args, tmpDir)` to invoke commands
- Parse output with `JSON.parse(result.output)`
- Use `assert.ok(result.success, ...)` for command success checks
- Use `assert.strictEqual` for value comparisons

**describe('config-delete command'):**

Test cases:
1. **deletes an existing key** -- config-set a key, then config-delete it, verify deleted:true, then config-get should fail
2. **returns deleted:false for missing key** -- config-delete a non-existent key, verify deleted:false (no error)
3. **deletes nested key without affecting siblings** -- config-set `workflow.a` and `workflow.b`, delete `workflow.a`, verify `workflow.b` still exists via config-get
4. **errors when config.json does not exist** -- run config-delete on a tmpDir with no config.json, verify result.success is false

Setup for tests that need config.json: create a minimal config.json in the tmpDir's `.planning/` directory using `fs.writeFileSync`:
```javascript
fs.writeFileSync(
  path.join(tmpDir, '.planning', 'config.json'),
  JSON.stringify({ workflow: { research: true } }, null, 2)
);
```

**describe('yolo-state command'):**

Test cases:
1. **write creates complete stanza** -- run `yolo-state write --start-phase 1`, verify output has `active: true`, `start_phase: 1`, and a non-empty `timestamp` string. Also verify config.json on disk has `workflow.yolo` with all three fields.
2. **write errors without --start-phase** -- run `yolo-state write` with no flags, verify result.success is false
3. **read returns stanza when present** -- write then read, verify output matches what was written
4. **read returns empty object when absent** -- create config.json without yolo stanza, run `yolo-state read`, verify output is `{}`
5. **clear removes stanza** -- write then clear, verify `cleared: true`. Then read, verify `{}`. Also verify config.json on disk still has `workflow` key but no `yolo` sub-key.
6. **clear is idempotent** -- clear when no stanza exists, verify `cleared: true` (no error)
7. **fail preserves existing fields and adds failure info** -- write, then fail with `--phase 2 --reason "verification gaps found"`, verify output has `active: false`, `start_phase: 1` (preserved), `timestamp` (preserved), `failed_phase: 2`, `failure_reason: "verification gaps found"`
8. **fail errors without --phase** -- run `yolo-state fail --reason "test"`, verify result.success is false
9. **fail errors without --reason** -- run `yolo-state fail --phase 2`, verify result.success is false
10. **errors on unknown subcommand** -- run `yolo-state unknown`, verify result.success is false

All tests that call write/read/clear/fail need a config.json in the tmpDir. Create it in beforeEach:
```javascript
fs.writeFileSync(
  path.join(tmpDir, '.planning', 'config.json'),
  JSON.stringify({ workflow: { research: true, plan_check: true, verifier: true } }, null, 2)
);
```
  </action>
  <verify>
Run the tests:
```bash
cd /home/junbeom/.claude/get-shit-done && node --test bin/gsd-tools.test.cjs 2>&1 | tail -30
```
All tests should pass. Specifically check that the new `config-delete` and `yolo-state` describe blocks report 0 failures.
  </verify>
  <done>
Two new `describe` blocks exist in gsd-tools.test.cjs: `config-delete command` (4 tests) and `yolo-state command` (10 tests). All 14 new tests pass. Tests cover happy paths, error cases, idempotent behavior, and field preservation.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add end-to-end lifecycle integration test</name>
  <files>/home/junbeom/.claude/get-shit-done/bin/gsd-tools.test.cjs</files>
  <action>
Append one more `describe` block after the yolo-state tests:

**describe('yolo-state lifecycle (integration)'):**

This test validates the full STATE-01 -> STATE-02 -> STATE-03 lifecycle in a single test case, mapping directly to the ROADMAP Phase 1 success criteria.

**Test: full write -> survive reset -> fail -> clear lifecycle**

Steps (in sequence within a single test):
1. Create config.json with standard workflow settings
2. **Write** (STATE-01): Run `yolo-state write --start-phase 1`, capture output, assert active/start_phase/timestamp present
3. **Survive reset** (STATE-02): Run `yolo-state read` in a completely separate process invocation (which is what `runGsdTools` already does -- each call is a fresh `execSync`). Verify the stanza returned matches step 2. This proves disk persistence across process boundaries, which is the mechanism that survives `/clear`.
4. **Also verify via config-get** (ROADMAP success criteria #1): Run `config-get workflow.yolo --raw`, parse the result, verify it has all three fields.
5. **Read-after-write verification** (ROADMAP success criteria #4): Already built into the write command, but also verify here: the stanza on disk (read via a raw `fs.readFileSync` of config.json) matches the write output.
6. **Fail** (STATE-03 failure path): Run `yolo-state fail --phase 2 --reason "verification gaps found"`, verify `active: false`, `failed_phase: 2`, and original `start_phase`/`timestamp` preserved.
7. **Clear** (STATE-03 manual override path): Run `yolo-state clear`, verify `cleared: true`.
8. **Verify clean** (STATE-03 complete): Run `yolo-state read`, verify `{}`. Also read config.json directly with `fs.readFileSync` and verify `workflow.yolo` is undefined but `workflow.research` etc. still exist.

This single comprehensive test maps to all four ROADMAP Phase 1 success criteria:
- Criteria 1: config-get returns active flag, start phase, timestamp (step 4)
- Criteria 2: stanza present after simulated reset (step 3)
- Criteria 3: stanza removed after clear (steps 7-8)
- Criteria 4: read-after-write verification (step 5)
  </action>
  <verify>
Run the tests:
```bash
cd /home/junbeom/.claude/get-shit-done && node --test bin/gsd-tools.test.cjs 2>&1 | tail -30
```
The lifecycle integration test should pass. All existing tests should continue to pass (no regressions).
  </verify>
  <done>
The lifecycle integration test exists and passes. It validates all four ROADMAP Phase 1 success criteria in sequence: write with verification, survive process restart, failure preservation, and complete cleanup. All pre-existing tests continue to pass.
  </done>
</task>

</tasks>

<verification>
Run the complete test suite to verify no regressions and all new tests pass:

```bash
cd /home/junbeom/.claude/get-shit-done && node --test bin/gsd-tools.test.cjs
```

Expected: All tests pass, including the new config-delete (4 tests), yolo-state (10 tests), and lifecycle (1 test) blocks. Total new tests: 15.

Also verify the test count increased by checking the final summary line.
</verification>

<success_criteria>
1. `config-delete command` describe block has 4 passing tests covering delete, idempotent missing, sibling preservation, and missing config.json
2. `yolo-state command` describe block has 10 passing tests covering all subcommands, error cases, and edge cases
3. `yolo-state lifecycle (integration)` describe block has 1 passing test covering the full STATE-01/02/03 lifecycle
4. All pre-existing tests still pass (no regressions)
5. Tests follow the exact patterns used in the existing test file (createTempProject, cleanup, runGsdTools, assert)
</success_criteria>

<output>
After completion, create `.planning/phases/01-state-infrastructure/01-02-SUMMARY.md`
</output>

---
phase: 03-integration-and-failure-hardening
plan: 02
type: execute
wave: 2
depends_on:
  - "03-01"
files_modified:
  - get-shit-done/workflows/yolo.md
autonomous: true
requirements:
  - FAIL-01
  - FAIL-02

must_haves:
  truths:
    - "After the chain returns to yolo.md, Phase C detects milestone completion by reading roadmap state (not Task() return text)"
    - "When verification finds gaps, yolo.md writes failure state via yolo-state fail and clears auto_advance"
    - "When verification finds gaps, yolo.md displays the phase number and specific unmet requirements"
    - "When an unexpected error stops the chain, yolo.md shows the raw error and suggests manual investigation"
    - "On failure, the yolo stanza is preserved in config.json (Phase 4 resume needs it)"
  artifacts:
    - path: "get-shit-done/workflows/yolo.md"
      provides: "Phase C chain result analysis with state-based detection and failure display"
      contains: "yolo-state fail"
  key_links:
    - from: "yolo.md Phase C"
      to: "roadmap analyze"
      via: "gsd-tools command to detect chain outcome"
      pattern: "roadmap analyze"
    - from: "yolo.md Phase C"
      to: "VERIFICATION.md"
      via: "disk-based gap detection"
      pattern: "VERIFICATION.md"
    - from: "yolo.md Phase C failure handler"
      to: "yolo-state fail + config-set workflow.auto_advance false"
      via: "gsd-tools state commands"
      pattern: "yolo-state fail"
---

<objective>
Extend yolo.md Phase C to detect chain outcomes and handle failures with clear user-facing output.

Purpose: Currently yolo.md's Phase C handler only detects plan-phase success/failure. After Plan 01 wires the full chain (plan->execute->verify->transition), the Task() in Phase C may return after running multiple phases successfully (milestone complete), after a verification failure stops the chain, or after an unexpected error. This plan adds post-Task() state analysis that reads disk state to determine what happened and responds appropriately — writing failure state, clearing auto_advance, and displaying actionable output per the locked decisions (FAIL-01, FAIL-02).

Output: Updated yolo.md workflow file (both source and installed copies).
</objective>

<execution_context>
@/home/junbeom/.claude/get-shit-done/workflows/execute-plan.md
@/home/junbeom/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-integration-and-failure-hardening/03-RESEARCH.md
@.planning/phases/03-integration-and-failure-hardening/03-01-SUMMARY.md
@.planning/phases/02-launcher/02-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Replace yolo.md Phase C return handler with state-based chain result analysis</name>
  <files>
    get-shit-done/workflows/yolo.md
    ~/.claude/get-shit-done/workflows/yolo.md
  </files>
  <action>
Replace the entire Phase C section in yolo.md. The current Phase C spawns a Task() for plan-phase and has a simple handler that checks for `## PLANNING COMPLETE` or `## PLANNING INCONCLUSIVE`. Replace it with a comprehensive post-Task() state analysis system.

**New Phase C structure:**

```markdown
## Phase C: Launch and Monitor

Spawn plan-phase as a subagent Task with `--auto` flag to propagate the auto-advance chain:

```
Task(
  prompt="Run /gsd:plan-phase ${NEXT_PHASE} --auto",
  subagent_type="general-purpose",
  description="YOLO: Phase ${NEXT_PHASE}"
)
```

### C1. Post-Chain State Analysis

After Task() returns, determine what happened by reading disk state. Do NOT parse the Task() return text — it is unreliable across different chain termination points.

**Read roadmap state:**

```bash
ANALYZE=$(node ~/.claude/get-shit-done/bin/gsd-tools.cjs roadmap analyze 2>/dev/null)
```

Extract from ANALYZE: `next_phase`, `completed_phases`, `phase_count`.

Calculate: `ALL_DONE` = true if `next_phase` is empty or null (all phases marked complete).

**Read YOLO stanza state:**

```bash
YOLO_STATE=$(node ~/.claude/get-shit-done/bin/gsd-tools.cjs yolo-state read --raw 2>/dev/null || echo '{}')
```

Extract: `active` field. If stanza is empty (`{}`), it was cleared by transition.md Route B (milestone complete path).

### C2. Route by Outcome

**Case A: Milestone Complete**

Condition: `ALL_DONE` is true (no next_phase) AND yolo stanza is empty or has `active: false`.

This means transition.md Route B already ran, showed the YOLO COMPLETE banner, cleared the yolo stanza, and cleared auto_advance. yolo.md has nothing more to do.

Display confirmation:

```
Chain complete. All phases finished.
```

Stop. Return to user.

**Case B: Chain Stopped — Determine Why**

Condition: `ALL_DONE` is false (next_phase exists). The chain stopped before completing all phases.

Determine the stopped phase: `STOPPED_PHASE` = the value of `next_phase` from roadmap analyze. This is the phase that did NOT complete.

Check for VERIFICATION.md to distinguish verification failure from unexpected error:

```bash
PADDED=$(printf "%02d" "$STOPPED_PHASE")
PHASE_DIR=$(ls -d ".planning/phases/${PADDED}-"* 2>/dev/null | head -1)
VERIFY_FILE="${PHASE_DIR}/${PADDED}-VERIFICATION.md"
```

**Case B1: Verification failure (FAIL-01, FAIL-02)**

Condition: `VERIFY_FILE` exists AND contains `status: gaps_found` (or similar indication of verification gaps).

Read the "What's Missing" or gaps section from VERIFICATION.md for display. Present the section verbatim — do not parse individual gap fields.

Write failure state (preserve yolo stanza for Phase 4 resume):

```bash
node ~/.claude/get-shit-done/bin/gsd-tools.cjs yolo-state fail --phase "${STOPPED_PHASE}" --reason "verification gaps found"
node ~/.claude/get-shit-done/bin/gsd-tools.cjs config-set workflow.auto_advance false
```

Display YOLO STOPPED banner (locked decision: show phase number + gaps, NO resume command):

```
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
 GSD ► YOLO STOPPED — Phase {STOPPED_PHASE}
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

Verification failed: Phase {STOPPED_PHASE} has unmet requirements.

**What was missing:**
{gaps section from VERIFICATION.md}

YOLO state preserved. See {VERIFY_FILE} for full report.
```

Stop. Do NOT auto-retry.

**Case B2: Unexpected error**

Condition: Chain stopped but VERIFICATION.md does not exist for the stopped phase, OR VERIFICATION.md exists with a status other than `gaps_found`.

Write failure state:

```bash
node ~/.claude/get-shit-done/bin/gsd-tools.cjs yolo-state fail --phase "${STOPPED_PHASE}" --reason "unexpected error — chain terminated without verification artifact"
node ~/.claude/get-shit-done/bin/gsd-tools.cjs config-set workflow.auto_advance false
```

Display unexpected error banner (locked decision: show raw error, suggest manual investigation):

```
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
 GSD ► YOLO STOPPED — Unexpected Error
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

The chain stopped at Phase {STOPPED_PHASE} without producing verification results.

This may be an agent crash, tool failure, or planning failure.
Investigate manually starting from Phase {STOPPED_PHASE}.

YOLO state preserved at Phase {STOPPED_PHASE}.
```

Stop. Do NOT auto-retry.
```

**Remove the old Phase 2 constraint comments.** The current yolo.md has these lines at the end:

```
**Constraints:**
- Do NOT use `config-set` on `workflow.research`, `workflow.plan_check`, or `workflow.verifier`
- Do NOT implement cleanup of `workflow.auto_advance` or `workflow.yolo` stanza (Phase 3 scope)
- Do NOT implement resume logic (Phase 4 scope)
```

Update the constraints section:
- Keep the first constraint (don't modify workflow agent settings)
- Remove the second constraint (Phase 3 now implements cleanup)
- Keep the third constraint (resume is Phase 4)
- Add: `- Do NOT parse Task() return text for chain outcome detection — always use disk state (roadmap analyze, yolo-state read, VERIFICATION.md)`

**CRITICAL:** Update both the git-tracked source file (`get-shit-done/workflows/yolo.md`) and the installed copy (`~/.claude/get-shit-done/workflows/yolo.md`). The source uses `~/.claude/` paths; the installed copy uses absolute `/home/junbeom/.claude/` paths.
  </action>
  <verify>
1. Read yolo.md Phase C — confirm Task() spawn is followed by C1 (state analysis) and C2 (outcome routing)
2. Confirm Case A (milestone complete) checks for empty next_phase AND empty yolo stanza
3. Confirm Case B1 (verification failure) reads VERIFICATION.md, runs yolo-state fail, clears auto_advance, shows STOPPED banner with gap details
4. Confirm Case B2 (unexpected error) handles missing VERIFICATION.md, runs yolo-state fail, clears auto_advance, shows error banner
5. Confirm constraints section is updated (cleanup now implemented, Task() parsing explicitly forbidden)
6. Confirm Phases A and B (prerequisite checks, state setup) are UNCHANGED
7. Verify both source and installed copies match in logic
  </verify>
  <done>
yolo.md Phase C uses state-based detection (roadmap analyze + yolo-state read + VERIFICATION.md) to determine chain outcome. Milestone complete = confirmation message. Verification failure = yolo-state fail + auto_advance clear + STOPPED banner with gaps. Unexpected error = yolo-state fail + auto_advance clear + error banner. No Task() return text parsing. Yolo stanza preserved on failure for Phase 4 resume.
  </done>
</task>

</tasks>

<verification>
1. yolo.md Phase A and B are unchanged (prerequisite checks and state setup)
2. yolo.md Phase C detects milestone completion via roadmap analyze (next_phase empty)
3. yolo.md Phase C detects verification failure via VERIFICATION.md presence + gaps_found status
4. yolo.md Phase C detects unexpected error when VERIFICATION.md is absent
5. On verification failure: yolo-state fail writes failure state, auto_advance is cleared, STOPPED banner shows phase + gaps
6. On unexpected error: yolo-state fail writes failure state, auto_advance is cleared, error banner shown
7. On milestone complete: no additional state changes needed (transition.md Route B already cleaned up)
8. yolo stanza preserved on failure (active: false + failed_phase set by yolo-state fail)
9. Both source and installed copies updated
</verification>

<success_criteria>
- YOLO hard-stops when verification finds gaps (FAIL-01)
- On stop, user sees phase number and specific unmet requirements (FAIL-02)
- Verification failures distinguished from unexpected errors in display format
- Failure state written to disk via yolo-state fail (preserved for Phase 4 resume)
- auto_advance cleared on failure to prevent unexpected auto-advance on next manual command
- No Task() return text parsing — all detection is disk-state-based
</success_criteria>

<output>
After completion, create `.planning/phases/03-integration-and-failure-hardening/03-02-SUMMARY.md`
</output>
